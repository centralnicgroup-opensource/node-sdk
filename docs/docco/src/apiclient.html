<!DOCTYPE html>

<html>
<head>
  <title>apiclient.ts</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="apiclient.html">
                  src/apiclient.ts
                </a>
              
                
                <a class="source" href="column.html">
                  src/column.ts
                </a>
              
                
                <a class="source" href="customlogger.html">
                  src/customlogger.ts
                </a>
              
                
                <a class="source" href="index.html">
                  src/index.ts
                </a>
              
                
                <a class="source" href="logger.html">
                  src/logger.ts
                </a>
              
                
                <a class="source" href="record.html">
                  src/record.ts
                </a>
              
                
                <a class="source" href="response.html">
                  src/response.ts
                </a>
              
                
                <a class="source" href="responseparser.html">
                  src/responseparser.ts
                </a>
              
                
                <a class="source" href="responsetemplate.html">
                  src/responsetemplate.ts
                </a>
              
                
                <a class="source" href="responsetemplatemanager.html">
                  src/responsetemplatemanager.ts
                </a>
              
                
                <a class="source" href="socketconfig.html">
                  src/socketconfig.ts
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>apiclient.ts</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">import</span> fetch <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;cross-fetch&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Logger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./logger.js&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Response</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./response.js&quot;</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ResponseTemplateManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./responsetemplatemanager.js&quot;</span>;
<span class="hljs-keyword">import</span> { fixedURLEnc, <span class="hljs-title class_">SocketConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./socketconfig.js&quot;</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_PROXY</span> = <span class="hljs-string">&quot;http://127.0.0.1/api/call.cgi&quot;</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_LIVE</span> = <span class="hljs-string">&quot;https://api.ispapi.net/api/call.cgi&quot;</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_OTE</span> =
  <span class="hljs-string">&quot;https://api-ote.ispapi.net/api/call.cgi&quot;</span>;

<span class="hljs-keyword">const</span> rtm = <span class="hljs-title class_">ResponseTemplateManager</span>.<span class="hljs-title function_">getInstance</span>();

<span class="hljs-comment">/**
 * APIClient class
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">APIClient</span> {
  <span class="hljs-comment">/**
   * API connection timeout setting
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">socketTimeout</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">300000</span>;
  <span class="hljs-comment">/**
   * User Agent string
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">ua</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/**
   * API connection url
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">socketURL</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/**
   * Object covering API connection data
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">socketConfig</span>: <span class="hljs-title class_">SocketConfig</span>;
  <span class="hljs-comment">/**
   * activity flag for debug mode
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">debugMode</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">/**
   * additional connection settings
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">curlopts</span>: <span class="hljs-built_in">any</span>;
  <span class="hljs-comment">/**
   * logger function for debug mode
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">logger</span>: <span class="hljs-title class_">Logger</span> | <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">public</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ua</span> = <span class="hljs-string">&quot;&quot;</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketURL</span> = <span class="hljs-string">&quot;&quot;</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">debugMode</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setURL</span>(<span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_LIVE</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketConfig</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SocketConfig</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">useLIVESystem</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">curlopts</span> = {};
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setDefaultLogger</span>();
  }

  <span class="hljs-comment">/**
   * set custom logger to use instead of default one
   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">customLogger</span>
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setCustomLogger</span>(<span class="hljs-attr">customLogger</span>: <span class="hljs-title class_">Logger</span>): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span> = customLogger;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  <span class="hljs-comment">/**
   * set default logger to use
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setDefaultLogger</span>(): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }
  <span class="hljs-comment">/**
   * Enable Debug Output to STDOUT
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">enableDebugMode</span>(): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">debugMode</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Disable Debug Output
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">disableDebugMode</span>(): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">debugMode</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Get the API Session that is currently set
   * <span class="hljs-doctag">@returns</span> API Session or null
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getSession</span>(): <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> {
    <span class="hljs-keyword">const</span> sessid = <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketConfig</span>.<span class="hljs-title function_">getSession</span>();
    <span class="hljs-keyword">return</span> sessid === <span class="hljs-string">&quot;&quot;</span> ? <span class="hljs-literal">null</span> : sessid;
  }

  <span class="hljs-comment">/**
   * Get the API connection url that is currently set
   * <span class="hljs-doctag">@returns</span> API connection url currently in use
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getURL</span>(): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketURL</span>;
  }

  <span class="hljs-comment">/**
   * Possibility to customize default user agent to fit your needs
   * <span class="hljs-doctag">@param</span> str user agent label
   * <span class="hljs-doctag">@param</span> rv revision of user agent
   * <span class="hljs-doctag">@param</span> modules further modules to add to user agent string, format: [&quot;&lt;mod1&gt;/&lt;rev&gt;&quot;, &quot;&lt;mod2&gt;/&lt;rev&gt;&quot;, ... ]
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setUserAgent</span>(<span class="hljs-attr">str</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">rv</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">modules</span>: <span class="hljs-built_in">any</span> = []): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-keyword">const</span> mods = modules.<span class="hljs-property">length</span> ? <span class="hljs-string">&quot; &quot;</span> + modules.<span class="hljs-title function_">join</span>(<span class="hljs-string">&quot; &quot;</span>) : <span class="hljs-string">&quot;&quot;</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ua</span> =
      <span class="hljs-string">`<span class="hljs-subst">${str}</span> `</span> +
      <span class="hljs-string">`(<span class="hljs-subst">${process.platform}</span>; <span class="hljs-subst">${process.arch}</span>; rv:<span class="hljs-subst">${rv}</span>)`</span> +
      mods +
      <span class="hljs-string">` node-sdk/<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getVersion()}</span> `</span> +
      <span class="hljs-string">`node/<span class="hljs-subst">${process.version}</span>`</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Get the User Agent
   * <span class="hljs-doctag">@returns</span> User Agent string
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getUserAgent</span>(): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">ua</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">ua</span> =
        <span class="hljs-string">`NODE-SDK (<span class="hljs-subst">${process.platform}</span>; <span class="hljs-subst">${
          process.arch
        }</span>; rv:<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getVersion()}</span>) `</span> + <span class="hljs-string">`node/<span class="hljs-subst">${process.version}</span>`</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">ua</span>;
  }

  <span class="hljs-comment">/**
   * Set the proxy server to use for API communication
   * <span class="hljs-doctag">@param</span> proxy proxy server to use for communicatio
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setProxy</span>(<span class="hljs-attr">proxy</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">curlopts</span>.<span class="hljs-property">proxy</span> = proxy;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Get the proxy server configuration
   * <span class="hljs-doctag">@returns</span> proxy server configuration value or null if not set
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getProxy</span>(): <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">hasOwnProperty</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">curlopts</span>, <span class="hljs-string">&quot;proxy&quot;</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">curlopts</span>.<span class="hljs-property">proxy</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">/**
   * Set the referer to use for API communication
   * <span class="hljs-doctag">@param</span> referer Referer
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setReferer</span>(<span class="hljs-attr">referer</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">curlopts</span>.<span class="hljs-property">referer</span> = referer;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Get the referer configuration
   * <span class="hljs-doctag">@returns</span> referer configuration value or null if not set
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getReferer</span>(): <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">hasOwnProperty</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">curlopts</span>, <span class="hljs-string">&quot;referer&quot;</span>)) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">curlopts</span>.<span class="hljs-property">referer</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  <span class="hljs-comment">/**
   * Get the current module version
   * <span class="hljs-doctag">@returns</span> module version
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getVersion</span>(): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;8.0.2&quot;</span>;
  }

  <span class="hljs-comment">/**
   * Apply session data (session id and system entity) to given client request session
   * <span class="hljs-doctag">@param</span> session ClientRequest session instance
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">saveSession</span>(<span class="hljs-attr">session</span>: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">APIClient</span> {
    session.<span class="hljs-property">socketcfg</span> = {
      <span class="hljs-attr">entity</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketConfig</span>.<span class="hljs-title function_">getSystemEntity</span>(),
      <span class="hljs-attr">session</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketConfig</span>.<span class="hljs-title function_">getSession</span>(),
    };
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Use existing configuration out of ClientRequest session
   * to rebuild and reuse connection settings
   * <span class="hljs-doctag">@param</span> session ClientRequest session instance
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">reuseSession</span>(<span class="hljs-attr">session</span>: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketConfig</span>.<span class="hljs-title function_">setSystemEntity</span>(session.<span class="hljs-property">socketcfg</span>.<span class="hljs-property">entity</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setSession</span>(session.<span class="hljs-property">socketcfg</span>.<span class="hljs-property">session</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Set another connection url to be used for API communication
   * <span class="hljs-doctag">@param</span> value API connection url to set
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setURL</span>(<span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketURL</span> = value;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Set one time password to be used for API communication
   * <span class="hljs-doctag">@param</span> value one time password
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setOTP</span>(<span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketConfig</span>.<span class="hljs-title function_">setOTP</span>(value);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Set an API session id to be used for API communication
   * <span class="hljs-doctag">@param</span> value API session id
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setSession</span>(<span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketConfig</span>.<span class="hljs-title function_">setSession</span>(value);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Set an Remote IP Address to be used for API communication
   * To be used in case you have an active ip filter setting.
   * <span class="hljs-doctag">@param</span> value Remote IP Address
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setRemoteIPAddress</span>(<span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketConfig</span>.<span class="hljs-title function_">setRemoteAddress</span>(value);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Set Credentials to be used for API communication
   * <span class="hljs-doctag">@param</span> uid account name
   * <span class="hljs-doctag">@param</span> pw account password
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setCredentials</span>(<span class="hljs-attr">uid</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">pw</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketConfig</span>.<span class="hljs-title function_">setLogin</span>(uid);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketConfig</span>.<span class="hljs-title function_">setPassword</span>(pw);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Set Credentials to be used for API communication
   * <span class="hljs-doctag">@param</span> uid account name
   * <span class="hljs-doctag">@param</span> role role user id
   * <span class="hljs-doctag">@param</span> pw role user password
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setRoleCredentials</span>(<span class="hljs-attr">uid</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">role</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">pw</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setCredentials</span>(role ? <span class="hljs-string">`<span class="hljs-subst">${uid}</span>!<span class="hljs-subst">${role}</span>`</span> : uid, pw);
  }

  <span class="hljs-comment">/**
   * Perform API login to start session-based communication
   * <span class="hljs-doctag">@param</span> otp optional one time password
   * <span class="hljs-doctag">@returns</span> Promise resolving with API Response
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">login</span>(otp = <span class="hljs-string">&quot;&quot;</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>&gt; {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setOTP</span>(otp || <span class="hljs-string">&quot;&quot;</span>);
    <span class="hljs-keyword">const</span> rr = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>({ <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StartSession&quot;</span> });
    <span class="hljs-keyword">if</span> (rr.<span class="hljs-title function_">isSuccess</span>()) {
      <span class="hljs-keyword">const</span> col = rr.<span class="hljs-title function_">getColumn</span>(<span class="hljs-string">&quot;SESSION&quot;</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setSession</span>(col ? col.<span class="hljs-title function_">getData</span>()[<span class="hljs-number">0</span>] : <span class="hljs-string">&quot;&quot;</span>);
    }
    <span class="hljs-keyword">return</span> rr;
  }

  <span class="hljs-comment">/**
   * Perform API login to start session-based communication.
   * Use given specific command parameters.
   * <span class="hljs-doctag">@param</span> params given specific command parameters
   * <span class="hljs-doctag">@param</span> otp optional one time password
   * <span class="hljs-doctag">@returns</span> Promise resolving with API Response
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">loginExtended</span>(<span class="hljs-attr">params</span>: <span class="hljs-built_in">any</span>, otp = <span class="hljs-string">&quot;&quot;</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>&gt; {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setOTP</span>(otp);
    <span class="hljs-keyword">const</span> rr = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(
        {
          <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;StartSession&quot;</span>,
        },
        params,
      ),
    );
    <span class="hljs-keyword">if</span> (rr.<span class="hljs-title function_">isSuccess</span>()) {
      <span class="hljs-keyword">const</span> col = rr.<span class="hljs-title function_">getColumn</span>(<span class="hljs-string">&quot;SESSION&quot;</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setSession</span>(col ? col.<span class="hljs-title function_">getData</span>()[<span class="hljs-number">0</span>] : <span class="hljs-string">&quot;&quot;</span>);
    }
    <span class="hljs-keyword">return</span> rr;
  }

  <span class="hljs-comment">/**
   * Perform API logout to close API session in use
   * <span class="hljs-doctag">@returns</span> Promise resolving with API Response
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">logout</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>&gt; {
    <span class="hljs-keyword">const</span> rr = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>({
      <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;EndSession&quot;</span>,
    });
    <span class="hljs-keyword">if</span> (rr.<span class="hljs-title function_">isSuccess</span>()) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setSession</span>(<span class="hljs-string">&quot;&quot;</span>);
    }
    <span class="hljs-keyword">return</span> rr;
  }

  <span class="hljs-comment">/**
   * Perform API request using the given command
   * <span class="hljs-doctag">@param</span> cmd API command to request
   * <span class="hljs-doctag">@returns</span> Promise resolving with API Response
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">request</span>(<span class="hljs-attr">cmd</span>: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>flatten nested api command bulk parameters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">let</span> mycmd = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">flattenCommand</span>(cmd);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>auto convert umlaut names to punycode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    mycmd = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">autoIDNConvert</span>(mycmd);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>request command to API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> <span class="hljs-attr">cfg</span>: <span class="hljs-built_in">any</span> = {
      <span class="hljs-attr">CONNECTION_URL</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketURL</span>,
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>TODO: 300s (to be sure to get an API response)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">const</span> <span class="hljs-attr">reqCfg</span>: <span class="hljs-built_in">any</span> = {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>encoding: “utf8”, //default for type string
gzip: true,</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-attr">body</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getPOSTData</span>(mycmd),
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">&quot;User-Agent&quot;</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUserAgent</span>(),
      },
      <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span>,
      <span class="hljs-attr">timeout</span>: <span class="hljs-title class_">APIClient</span>.<span class="hljs-property">socketTimeout</span>,
      <span class="hljs-attr">url</span>: cfg.<span class="hljs-property">CONNECTION_URL</span>,
    };
    <span class="hljs-keyword">const</span> proxy = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getProxy</span>();
    <span class="hljs-keyword">if</span> (proxy) {
      reqCfg.<span class="hljs-property">proxy</span> = proxy;
    }
    <span class="hljs-keyword">const</span> referer = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getReferer</span>();
    <span class="hljs-keyword">if</span> (referer) {
      reqCfg.<span class="hljs-property">headers</span>.<span class="hljs-property">Referer</span> = referer;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(cfg.<span class="hljs-property">CONNECTION_URL</span>, reqCfg)
      .<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> (<span class="hljs-attr">res</span>: <span class="hljs-built_in">any</span>) =&gt; {
        <span class="hljs-keyword">let</span> error = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">let</span> body;
        <span class="hljs-keyword">if</span> (res.<span class="hljs-property">ok</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>res.status &gt;= 200 &amp;&amp; res.status &lt; 300</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          body = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">text</span>();
        } <span class="hljs-keyword">else</span> {
          error = res.<span class="hljs-property">status</span> + (res.<span class="hljs-property">statusText</span> ? <span class="hljs-string">&quot; &quot;</span> + res.<span class="hljs-property">statusText</span> : <span class="hljs-string">&quot;&quot;</span>);
          body = rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;httperror&quot;</span>).<span class="hljs-title function_">getPlain</span>();
        }
        <span class="hljs-keyword">const</span> rr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(body, mycmd, cfg);
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">debugMode</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getPOSTData</span>(mycmd, <span class="hljs-literal">true</span>), rr, error);
        }
        <span class="hljs-keyword">return</span> rr;
      })
      .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> body = rtm.<span class="hljs-title function_">getTemplate</span>(<span class="hljs-string">&quot;httperror&quot;</span>).<span class="hljs-title function_">getPlain</span>();
        <span class="hljs-keyword">const</span> rr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(body, mycmd, cfg);
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">debugMode</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getPOSTData</span>(mycmd, <span class="hljs-literal">true</span>), rr, err.<span class="hljs-property">message</span>);
        }
        <span class="hljs-keyword">return</span> err;
      });
  }

  <span class="hljs-comment">/**
   * Request the next page of list entries for the current list query
   * Useful for tables
   * <span class="hljs-doctag">@param</span> rr API Response of current page
   * <span class="hljs-doctag">@returns</span> Promise resolving with API Response or null in case there are no further list entries
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">requestNextResponsePage</span>(<span class="hljs-attr">rr</span>: <span class="hljs-title class_">Response</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span> | <span class="hljs-literal">null</span>&gt; {
    <span class="hljs-keyword">const</span> mycmd = rr.<span class="hljs-title function_">getCommand</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">hasOwnProperty</span>.<span class="hljs-title function_">call</span>(mycmd, <span class="hljs-string">&quot;LAST&quot;</span>)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(
        <span class="hljs-string">&quot;Parameter LAST in use. Please remove it to avoid issues in requestNextPage.&quot;</span>,
      );
    }
    <span class="hljs-keyword">let</span> first = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">hasOwnProperty</span>.<span class="hljs-title function_">call</span>(mycmd, <span class="hljs-string">&quot;FIRST&quot;</span>)) {
      first = mycmd.<span class="hljs-property">FIRST</span>;
    }
    <span class="hljs-keyword">const</span> total = rr.<span class="hljs-title function_">getRecordsTotalCount</span>();
    <span class="hljs-keyword">const</span> limit = rr.<span class="hljs-title function_">getRecordsLimitation</span>();
    first += limit;
    <span class="hljs-keyword">if</span> (first &lt; total) {
      mycmd.<span class="hljs-property">FIRST</span> = first;
      mycmd.<span class="hljs-property">LIMIT</span> = limit;
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(mycmd);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
  }

  <span class="hljs-comment">/**
   * Request all pages/entries for the given query command
   * <span class="hljs-doctag">@param</span> cmd API list command to use
   * <span class="hljs-doctag">@returns</span> Promise resolving with array of API Responses
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">requestAllResponsePages</span>(<span class="hljs-attr">cmd</span>: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>[]&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">responses</span>: <span class="hljs-title class_">Response</span>[] = [];
    <span class="hljs-keyword">const</span> <span class="hljs-attr">rr</span>: <span class="hljs-title class_">Response</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>(
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, cmd, { <span class="hljs-attr">FIRST</span>: <span class="hljs-number">0</span> }),
    );
    <span class="hljs-keyword">let</span> <span class="hljs-attr">tmp</span>: <span class="hljs-title class_">Response</span> | <span class="hljs-literal">null</span> = rr;
    <span class="hljs-keyword">let</span> idx = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">do</span> {
      responses[idx++] = tmp;
      tmp = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">requestNextResponsePage</span>(tmp);
    } <span class="hljs-keyword">while</span> (tmp !== <span class="hljs-literal">null</span>);
    <span class="hljs-keyword">return</span> responses;
  }

  <span class="hljs-comment">/**
   * Set a data view to a given subuser
   * <span class="hljs-doctag">@param</span> uid subuser account name
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">setUserView</span>(<span class="hljs-attr">uid</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketConfig</span>.<span class="hljs-title function_">setUser</span>(uid);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Reset data view back from subuser to user
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">resetUserView</span>(): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketConfig</span>.<span class="hljs-title function_">setUser</span>(<span class="hljs-string">&quot;&quot;</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Activate High Performance Connection Setup
   * <span class="hljs-doctag">@see</span> https://github.com/centralnicgroup-opensource/rtldev-middleware-node-sdk/blob/master/README.md
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">useHighPerformanceConnectionSetup</span>(): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setURL</span>(<span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_PROXY</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Activate Default Connection Setup (the default)
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">useDefaultConnectionSetup</span>(): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setURL</span>(<span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_LIVE</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Set OT&amp;E System for API communication
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">useOTESystem</span>(): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setURL</span>(<span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_OTE</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketConfig</span>.<span class="hljs-title function_">setSystemEntity</span>(<span class="hljs-string">&quot;1234&quot;</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Set LIVE System for API communication (this is the default setting)
   * <span class="hljs-doctag">@returns</span> Current APIClient instance for method chaining
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">useLIVESystem</span>(): <span class="hljs-title class_">APIClient</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setURL</span>(<span class="hljs-variable constant_">ISPAPI_CONNECTION_URL_LIVE</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketConfig</span>.<span class="hljs-title function_">setSystemEntity</span>(<span class="hljs-string">&quot;54cd&quot;</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-comment">/**
   * Serialize given command for POST request including connection configuration data
   * <span class="hljs-doctag">@param</span> cmd API command to encode
   * <span class="hljs-doctag">@returns</span> encoded POST data string
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getPOSTData</span>(<span class="hljs-attr">cmd</span>: <span class="hljs-built_in">any</span>, secured = <span class="hljs-literal">false</span>): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">let</span> data = <span class="hljs-variable language_">this</span>.<span class="hljs-property">socketConfig</span>.<span class="hljs-title function_">getPOSTData</span>();
    <span class="hljs-keyword">if</span> (secured) {
      data = data.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/s_pw=[^&amp;]+/</span>, <span class="hljs-string">&quot;s_pw=***&quot;</span>);
    }

    <span class="hljs-keyword">let</span> tmp = <span class="hljs-string">&quot;&quot;</span>;
    <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">typeof</span> cmd === <span class="hljs-string">&quot;string&quot;</span> || cmd <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">String</span>)) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(cmd).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (cmd[key] !== <span class="hljs-literal">null</span> &amp;&amp; cmd[key] !== <span class="hljs-literal">undefined</span>) {
          tmp += <span class="hljs-string">`<span class="hljs-subst">${key}</span>=<span class="hljs-subst">${cmd[key].toString().replace(/\r|\n/g, <span class="hljs-string">&quot;&quot;</span>)}</span>\n`</span>;
        }
      });
    } <span class="hljs-keyword">else</span> {
      tmp = <span class="hljs-string">&quot;&quot;</span> + cmd;
    }
    <span class="hljs-keyword">if</span> (secured) {
      tmp = tmp.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/PASSWORD=[^\n]+/</span>, <span class="hljs-string">&quot;PASSWORD=***&quot;</span>);
    }
    tmp = tmp.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\n$/</span>, <span class="hljs-string">&quot;&quot;</span>);
    data += <span class="hljs-string">`<span class="hljs-subst">${fixedURLEnc(<span class="hljs-string">&quot;s_command&quot;</span>)}</span>=<span class="hljs-subst">${fixedURLEnc(tmp)}</span>`</span>;
    <span class="hljs-keyword">return</span> data;
  }

  <span class="hljs-comment">/**
   * Flatten nested arrays in command
   * <span class="hljs-doctag">@param</span> cmd api command
   * <span class="hljs-doctag">@returns</span> api command with flattended parameters
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">flattenCommand</span>(<span class="hljs-attr">cmd</span>: <span class="hljs-built_in">any</span>): <span class="hljs-built_in">any</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">newcmd</span>: <span class="hljs-built_in">any</span> = {};
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(cmd).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> val = cmd[key];
      <span class="hljs-keyword">const</span> newKey = key.<span class="hljs-title function_">toUpperCase</span>();
      <span class="hljs-keyword">if</span> (val !== <span class="hljs-literal">null</span> &amp;&amp; val !== <span class="hljs-literal">undefined</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(val)) {
          <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> row <span class="hljs-keyword">of</span> val) {
            newcmd[<span class="hljs-string">`<span class="hljs-subst">${newKey}</span><span class="hljs-subst">${index}</span>`</span>] = (row + <span class="hljs-string">&quot;&quot;</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\r|\n/g</span>, <span class="hljs-string">&quot;&quot;</span>);
            index++;
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> val === <span class="hljs-string">&quot;string&quot;</span> || val <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">String</span>) {
            newcmd[newKey] = val.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\r|\n/g</span>, <span class="hljs-string">&quot;&quot;</span>);
          } <span class="hljs-keyword">else</span> {
            newcmd[newKey] = val;
          }
        }
      }
    });
    <span class="hljs-keyword">return</span> newcmd;
  }

  <span class="hljs-comment">/**
   * Auto convert API command parameters to punycode, if necessary.
   * <span class="hljs-doctag">@param</span> cmd api command
   * <span class="hljs-doctag">@returns</span> Promise resolving with api command with IDN values replaced to punycode
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">autoIDNConvert</span>(<span class="hljs-attr">cmd</span>: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>don’t convert for convertidn command to avoid endless loop
and ignore commands in string format (even deprecated)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (
      <span class="hljs-keyword">typeof</span> cmd === <span class="hljs-string">&quot;string&quot;</span> ||
      cmd <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">String</span> ||
      <span class="hljs-regexp">/^CONVERTIDN$/i</span>.<span class="hljs-title function_">test</span>(cmd.<span class="hljs-property">COMMAND</span>)
    ) {
      <span class="hljs-keyword">return</span> cmd;
    }
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(cmd).<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-regexp">/^(DOMAIN|NAMESERVER|DNSZONE)([0-9]*)$/i</span>.<span class="hljs-title function_">test</span>(key);
    });
    <span class="hljs-keyword">if</span> (!keys.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span> cmd;
    }
    <span class="hljs-keyword">const</span> <span class="hljs-attr">toconvert</span>: <span class="hljs-built_in">any</span> = [];
    <span class="hljs-keyword">const</span> <span class="hljs-attr">idxs</span>: <span class="hljs-built_in">string</span>[] = [];
    keys.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (
        cmd[key] !== <span class="hljs-literal">null</span> &amp;&amp;
        cmd[key] !== <span class="hljs-literal">undefined</span> &amp;&amp;
        <span class="hljs-regexp">/[^a-z0-9.\- ]/i</span>.<span class="hljs-title function_">test</span>(cmd[key])
      ) {
        toconvert.<span class="hljs-title function_">push</span>(cmd[key]);
        idxs.<span class="hljs-title function_">push</span>(key);
      }
    });

    <span class="hljs-keyword">if</span> (!toconvert.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span> cmd;
    }
    <span class="hljs-keyword">const</span> r = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">request</span>({
      <span class="hljs-attr">COMMAND</span>: <span class="hljs-string">&quot;ConvertIDN&quot;</span>,
      <span class="hljs-attr">DOMAIN</span>: toconvert,
    });
    <span class="hljs-keyword">if</span> (r.<span class="hljs-title function_">isSuccess</span>()) {
      <span class="hljs-keyword">const</span> col = r.<span class="hljs-title function_">getColumn</span>(<span class="hljs-string">&quot;ACE&quot;</span>);
      <span class="hljs-keyword">if</span> (col) {
        col.<span class="hljs-title function_">getData</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">pc: <span class="hljs-built_in">string</span>, idx: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
          cmd[idxs[idx]] = pc;
        });
      }
    }
    <span class="hljs-keyword">return</span> cmd;
  }
}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
